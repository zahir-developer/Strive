// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using CoreFoundation;
using Foundation;
using Greeter.Common;
using Greeter.DTOs;
using Greeter.Extensions;
using Greeter.Modules.Pay;
using Greeter.Services.Api;
using UIKit;

namespace Greeter.Storyboards
{
    public partial class EmailViewController : BaseViewController, IUIPickerViewDelegate, IUIPickerViewDataSource, IUITextFieldDelegate
    {
        // Data
        const string SCREEN_TITLE = "Email Receipt";
        //public string[] data = new string[] {
        //    "Main Street 1",
        //    "Main Street 2",
        //    "Main Street 3"
        //};

        public string Make;
        public string Model;
        public string Color;
        public string CustName;
        public CreateServiceRequest Service;
        public ServiceType ServiceType;

        List<Employee> Employees;
        string[] employeeNames;

        string selectedEmpEmailId;

        //Views
        UIPickerView pv = new UIPickerView();

        public EmailViewController(IntPtr handle) : base(handle)
        {
        }

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();

            NavigationController.NavigationBar.Hidden = true;

            Initialise();

#if DEBUG
            tfCust.Text = "karthiknever16@gmail.com";
#endif

            //Clicks
            btnEmpDropdown.TouchUpInside += delegate
            {
                tfEmp.BecomeFirstResponder();
            };

            btnEmpSent.TouchUpInside += delegate
            {
                if (selectedEmpEmailId.IsEmpty())
                {
                    ShowAlertMsg(Common.Messages.EMPLOYEE_MISSING);
                    return;
                }

                _ = SendEmail(selectedEmpEmailId);
            };

            btnCustomerSend.TouchUpInside += delegate
            {
                if (tfCust.Text.IsEmpty())
                {
                    ShowAlertMsg(Common.Messages.EMAIL_MISSING);
                    return;
                }

                _ = SendEmail(tfCust.Text);
            };

            //Clicks
            btnPayLater.TouchUpInside += delegate
            {
                //var vc = NavigationController.ViewControllers[NavigationController.ViewControllers.Length - 3];
                NavigationController.PopToRootViewController(true);
            };

            //btnPrint.TouchUpInside += delegate
            //{
            //    //TODO : Temprary Loader to hide not done this functionality
            //    _ = ShowLoader();
            //};

            btnPay.TouchUpInside += delegate
            {
                NavigateToPayScreen();
            };
        }

        [Export("textFieldShouldReturn:")]
        public bool ShouldReturn(UITextField textField)
        {
            textField.EndEditing(true);
            return true;
        }

        async Task ShowLoader()
        {
            ShowActivityIndicator();
            await Task.Delay(3000);
            HideActivityIndicator();
        }

        async Task GetData()
        {
            ShowActivityIndicator();
            var apiService = new WashApiService();
            var req = new GetDetailEmployeeReq
            {
                LocationID = AppSettings.LocationID
            };

            var employeesResponse = await apiService.GetDetailEmployees(req);
            Employees = employeesResponse?.EmployeeList;
            employeeNames = Employees?.Select(x => x.FirstName + " " + x.LastName).ToArray();

            if (employeeNames.Length  > 0)
            {
                AddPickerToolbar(tfEmp, tfEmp.Placeholder, PickerDone);
                tfEmp.InputView = pv;
            }

            HideActivityIndicator();
        }

        async Task SendEmail(string email)
        {
            try
            {
                if (!email.IsEmail())
                {
                    ShowAlertMsg(Common.Messages.EMAIL_WARNING);
                    return;
                }

                ShowActivityIndicator();

                var body = "<p>Ticket Number : </p>" + Service.Job.JobId + "<br /><br />";

                if (Service.Job.ClientId != 0 && Service.Job.ClientId is not null)
                {
                    body += "<p>Customer Details : </p>" + ""
                        + "<p>Customer Name - " + CustName + "</p><br />";
                }

                body += "<p>Vehicle Details : </p>" +
                     "<p>Make - " + Make + "</p>" +
                    "<p>Model - " + Model + "</p>" +
                     "<p>Color - " + Color + "</p><br />" +
                     "<p>Services : " + "</p>";

                var totalAmt = 0f;
                for (int i = 0; i < Service.JobItems.Count; i++)
                {
                    var job = Service.JobItems[i];
                    var price = job.Price.ToString();
                    if ((job.Price % 1) == 0)
                    {
                        price += ":00";
                    }
                    else
                    {
                        var values = price.Split(".");
                        price = (int)job.Price + ":" + values[1];
                    }

                    body += "<p>" + job.SeriveName + " - " + "$" + price + "</p>";
                    totalAmt += job.Price;
                }

                body += "<br/ ><p>" + "Total Amount : " + totalAmt.ToString() + "</p>";

                //body = "<div>Something</div>";

                Debug.WriteLine("Email Body :" + body);

                string subject = null;
                if (ServiceType == ServiceType.Wash)
                    subject = Common.Messages.SERVICE_RECEIPT_SUBJECT;
                else // DETAIL
                    subject = Common.Messages.DETAIL_RECEIPT_SUBJECT;

                var response = await new WashApiService().SendEmail(email, subject, body);
                HideActivityIndicator();

                HandleResponse(response);

                if (response.IsSuccess())
                {
                    ShowAlertMsg(Common.Messages.EMAIL_SENT_MSG, titleTxt: Common.Messages.EMAIL);
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine("Exception happened and the reason is : " + ex.Message);
                HideActivityIndicator();
            }
        }

        void Initialise()
        {
            Title = SCREEN_TITLE;

            tfCust.WeakDelegate = this;

            tfEmp.AddLeftPadding(UIConstants.TEXT_FIELD_HORIZONTAL_PADDING);
            tfEmp.AddRightPadding(UIConstants.TEXT_FIELD_RIGHT_BUTTON_PADDING);

            tfCust.AddLeftPadding(UIConstants.TEXT_FIELD_HORIZONTAL_PADDING);
            tfCust.AddRightPadding(UIConstants.TEXT_FIELD_RIGHT_BUTTON_PADDING);

            // For Restricting typing in the location field
            tfEmp.ShouldChangeCharacters = (textField, range, replacementString) =>
            {
                return false;
            };

            pv.DataSource = this;
            pv.Delegate = this;

            if (ServiceType == ServiceType.Wash)
            {
                viewDetailer.Hidden = true;
            }
            else
            {
                _ = GetData();
            }
        }

        void PickerDone()
        {
            if (employeeNames.Length > 0)
            {
                int pos = (int)pv.SelectedRowInComponent(0);
                tfEmp.Text = employeeNames[pos];
                selectedEmpEmailId = Employees[pos].EmailID;
            }
        }

        void NavigateToPayScreen()
        {
            var vc = new PaymentViewController();
            vc.JobID = Service.Job.JobId;
            vc.Make = Make;
            vc.Model = Model;
            vc.Color = Color;
            vc.CustName = CustName;
            

            var mainService  = Service.JobItems.First(x => x.IsMainService);

            vc.ServiceName = mainService.SeriveName;

            var totalAmt = 0f;
            for (int i = 0; i < Service.JobItems.Count; i++)
            {
                totalAmt += Service.JobItems[i].Price;
            }

            vc.Amount = totalAmt;
            //TOdo : 
            //vc.ServiceName = checkout.Services;
            //vc.AdditionalServiceName = ;

            NavigateToWithAnim(vc);
        }

        public nint GetComponentCount(UIPickerView pickerView)
        {
            return 1;
        }

        public nint GetRowsInComponent(UIPickerView pickerView, nint component)
        {
            return employeeNames?.Length ?? 0;
        }

        [Export("pickerView:didSelectRow:inComponent:")]
        public void Selected(UIPickerView pickerView, nint row, nint component)
        {

        }

        [Export("pickerView:titleForRow:forComponent:")]
        public string GetTitle(UIPickerView pickerView, nint row, nint component)
        {
            return employeeNames[row];
        }
    }
}
